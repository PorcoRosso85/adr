#!/usr/bin/env bash
set -euo pipefail
PREVIEW="${1:-adr/log.jsonl.preview}"

jq -s '
  def sup_ids: (reduce .[] as $e ({}; if $e.supersedes then .[$e.supersedes]=true else . end));
  def current:
    ( . as $all
    | (sup_ids) as $sup
    | [ $all[] | select(.status=="Accepted") | select( ($sup[.id]) | not ) ] );
  (current | group_by(.uri) | map(select(length>1) | {uri: .[0].uri, ids: map(.id)})) as $dups
  | if ($dups|length)>0 then
      {ok:false, dups:$dups}
    else
      {ok:true}
    end' "$PREVIEW" | \
  jq -e '.ok == true' >/dev/null || {
    echo "[ERROR] multiple current Accepted per URI"; exit 1; }

echo "[OK] cross-constraints passed"
